<!DOCTYPE html>
<html>
  <head>
    <title>Spectrum explorer (CG22/23 U7)</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="author" content="TU-Ilmenau, 2022-11-29" />

    <style type="text/css">
      table,
      th,
      td {
        border: 1px solid black;
        padding: 0.3em;
        border-collapse: collapse;
      }
    </style>
  </head>
  <body onload="init()">
    <div id="A1"></div>

    <script>
      // see data for CIE 1931 standard colorimetric observer
      let cieCurves = [
        //0 nm   1 R       2 G       3 B         4 x       5 y        6 D65
        [380, 0.001368, 0.000039, 0.00645, 0.17411, 0.00496, 49, 9755],
        [385, 0.002236, 0.000064, 0.01055, 0.17401, 0.00498, 52, 3118],
        [390, 0.004243, 0.00012, 0.02005, 0.1738, 0.00492, 54, 6482],
        [395, 0.00765, 0.000217, 0.03621, 0.17356, 0.00492, 68, 7015],
        [400, 0.01431, 0.000396, 0.06785, 0.17334, 0.0048, 82, 7549],
        [405, 0.02319, 0.00064, 0.1102, 0.17302, 0.00478, 87, 1204],
        [410, 0.04351, 0.00121, 0.2074, 0.17258, 0.0048, 91, 4860],
        [415, 0.07763, 0.00218, 0.3713, 0.17209, 0.00483, 92, 4589],
        [420, 0.13438, 0.004, 0.6456, 0.17141, 0.0051, 93, 4318],
        [425, 0.21477, 0.0073, 1.03905, 0.1703, 0.00579, 90, 0570],
        [430, 0.2839, 0.0116, 1.3856, 0.16888, 0.0069, 86, 6823],
        [435, 0.3285, 0.01684, 1.62296, 0.1669, 0.00856, 95, 7736],
        [440, 0.34828, 0.023, 1.74706, 0.16441, 0.01086, 104, 8650],
        [445, 0.34806, 0.0298, 1.7826, 0.1611, 0.01379, 110, 9360],
        [450, 0.3362, 0.038, 1.77211, 0.15664, 0.0177, 117, 0080],
        [455, 0.3187, 0.048, 1.7441, 0.15099, 0.02274, 117, 4100],
        [460, 0.2908, 0.06, 1.6692, 0.14396, 0.0297, 117, 8120],
        [465, 0.2511, 0.0739, 1.5281, 0.1355, 0.03988, 116, 3360],
        [470, 0.19536, 0.09098, 1.28764, 0.12412, 0.0578, 114, 8610],
        [475, 0.1421, 0.1126, 1.0419, 0.10959, 0.08684, 115, 3920],
        [480, 0.09564, 0.13902, 0.81295, 0.09129, 0.1327, 115, 9230],
        [485, 0.05795, 0.1693, 0.6162, 0.06871, 0.20072, 112, 3670],
        [490, 0.03201, 0.20802, 0.46518, 0.04539, 0.29498, 108, 8110],
        [495, 0.0147, 0.2586, 0.3533, 0.02346, 0.4127, 109, 0820],
        [500, 0.0049, 0.323, 0.272, 0.00817, 0.53842, 109, 3540],
        [505, 0.0024, 0.4073, 0.2123, 0.00386, 0.65482, 108, 5780],
        [510, 0.0093, 0.503, 0.1582, 0.01387, 0.75019, 107, 8020],
        [515, 0.0291, 0.6082, 0.1117, 0.03885, 0.81202, 106, 2960],
        [520, 0.06327, 0.71, 0.07825, 0.0743, 0.8338, 104, 7900],
        [525, 0.1096, 0.7932, 0.05725, 0.11416, 0.82621, 106, 2390],
        [530, 0.1655, 0.862, 0.04216, 0.15472, 0.80586, 107, 6890],
        [535, 0.22575, 0.91485, 0.02984, 0.19288, 0.78163, 106, 0470],
        [540, 0.2904, 0.954, 0.0203, 0.22962, 0.75433, 104, 4050],
        [545, 0.3597, 0.9803, 0.0134, 0.26578, 0.72432, 104, 2250],
        [550, 0.43345, 0.99495, 0.00875, 0.3016, 0.69231, 104, 0460],
        [555, 0.51205, 1.0, 0.00575, 0.33736, 0.65885, 102, 0230],
        [560, 0.5945, 0.995, 0.0039, 0.3731, 0.62445, 100, 0000],
        [565, 0.6784, 0.9786, 0.00275, 0.40874, 0.58961, 98, 1671],
        [570, 0.7621, 0.952, 0.0021, 0.44406, 0.55471, 96, 3342],
        [575, 0.8425, 0.9154, 0.0018, 0.47877, 0.5202, 96, 0611],
        [580, 0.9163, 0.87, 0.00165, 0.51249, 0.48659, 95, 7880],
        [585, 0.9786, 0.8163, 0.0014, 0.54479, 0.45443, 92, 2368],
        [590, 1.0263, 0.757, 0.0011, 0.57515, 0.42423, 88, 6856],
        [595, 1.0567, 0.6949, 0.001, 0.60293, 0.3965, 89, 3459],
        [600, 1.0622, 0.631, 0.0008, 0.62704, 0.37249, 90, 0062],
        [605, 1.0456, 0.5668, 0.0006, 0.64823, 0.35139, 89, 8026],
        [610, 1.0026, 0.503, 0.00034, 0.66576, 0.33401, 89, 5991],
        [615, 0.9384, 0.4412, 0.00024, 0.68008, 0.31975, 88, 6489],
        [620, 0.85445, 0.381, 0.00019, 0.6915, 0.30834, 87, 6987],
        [625, 0.7514, 0.321, 0.0001, 0.70061, 0.2993, 85, 4936],
        [630, 0.6424, 0.265, 0.00005, 0.70792, 0.29203, 83, 2886],
        [635, 0.5419, 0.217, 0.00003, 0.71403, 0.28593, 83, 4939],
        [640, 0.4479, 0.175, 0.00002, 0.71903, 0.28093, 83, 6992],
        [645, 0.3608, 0.1382, 0.00001, 0.72303, 0.27695, 81, 8630],
        [650, 0.2835, 0.107, 0.0, 0.72599, 0.27401, 80, 0268],
        [655, 0.2187, 0.0816, 0.0, 0.72827, 0.27173, 80, 1207],
        [660, 0.1649, 0.061, 0.0, 0.72997, 0.27003, 80, 2146],
        [665, 0.1212, 0.04458, 0.0, 0.73109, 0.26891, 81, 2462],
        [670, 0.0874, 0.032, 0.0, 0.73199, 0.26801, 82, 2778],
        [675, 0.0636, 0.0232, 0.0, 0.73272, 0.26728, 80, 2810],
        [680, 0.04677, 0.017, 0.0, 0.73342, 0.26658, 78, 2842],
        [685, 0.0329, 0.01192, 0.0, 0.73405, 0.26595, 74, 0027],
        [690, 0.0227, 0.00821, 0.0, 0.73439, 0.26561, 69, 7213],
        [695, 0.01584, 0.005723, 0.0, 0.73459, 0.26541, 70, 6652],
        [700, 0.011359, 0.004102, 0.0, 0.73469, 0.26531, 71, 6091],
        [705, 0.008111, 0.002929, 0.0, 0.73469, 0.26531, 72, 9790],
        [710, 0.00579, 0.002091, 0.0, 0.73469, 0.26531, 74, 3490],
        [715, 0.004109, 0.001484, 0.0, 0.73469, 0.26531, 67, 9765],
        [720, 0.002899, 0.001047, 0.0, 0.73469, 0.26531, 61, 6040],
        [725, 0.002049, 0.00074, 0.0, 0.73469, 0.26531, 65, 7448],
        [730, 0.00144, 0.00052, 0.0, 0.73469, 0.26531, 69, 8856],
        [735, 0.001, 0.000361, 0.0, 0.73469, 0.26531, 72, 4863],
        [740, 0.00069, 0.000249, 0.0, 0.73469, 0.26531, 75, 0870],
        [745, 0.000476, 0.000172, 0.0, 0.73469, 0.26531, 69, 3398],
        [750, 0.000332, 0.00012, 0.0, 0.73469, 0.26531, 63, 5927],
        [755, 0.000235, 0.000085, 0.0, 0.73469, 0.26531, 55, 0054],
        [760, 0.000166, 0.00006, 0.0, 0.73469, 0.26531, 46, 4182],
        [765, 0.000117, 0.000042, 0.0, 0.73469, 0.26531, 56, 6118],
        [770, 0.000083, 0.00003, 0.0, 0.73469, 0.26531, 66, 8054],
        [775, 0.000059, 0.000021, 0.0, 0.73469, 0.26531, 65, 0941],
        [780, 0.000042, 0.000015, 0.0, 0.73469, 0.26531, 63, 3828],
      ];

      let datA1 = [
        [400, 450, 500, 550, 600, 650, 700],
        [0.7, 0.3, 0.8, 0.4, 0.8, 0.1, 1.0],
        [0.1, , 0.3, 0.4, 0.2, 0.8, 0.6],
        [, , , , , ,],
      ];

      function cieObsR(nm) {
        return cieObsX(nm, 1);
      }
      function cieObsG(nm) {
        return cieObsX(nm, 2);
      }
      function cieObsB(nm) {
        return cieObsX(nm, 3);
      }
      function cieObsX(nm, c) {
        let idxDbl = (nm - 380) / 5;
        if (idxDbl < 0 || idxDbl >= cieCurves.length) return 0;
        let i1 = idxDbl | 0; // could also use Math.floor() here.
        let i2 = i1 + 1;
        return linInt(
          idxDbl,
          cieCurves[i1][0],
          cieCurves[i1][c],
          cieCurves[i2][0],
          cieCurves[i2][c]
        );
      }

      function init() {
        initA1();
      }

      function initA1() {
        let A1 = document.getElementById("A1");
        if (!A1 || !datA1) return;

        A1.innerHTML += "<b>Gegeben</b><br>";
        let T1 = genTabWithDat(A1, datA1);

        datA1[2][1] = 0.2;
        A1.innerHTML += "<br><b>Lösung</b><br>";
        let T2 = genTabWithDat(A1, datA1);
        fillTabWithDat(T2, datA1);
      }

      function genTabWithDat(theDiv, theDat) {
        if (!theDiv || !theDat) return;

        let ld = theDat[0].length;
        let nc = ld + 4; // incl. name, R, G, B
        let nr = 4;
        let tab = generateTableAsChildOf(nc, nr, theDiv);
        tab.rows[0].cells[0].innerHTML = "Wellenlänge in nm";
        tab.rows[1].cells[0].innerHTML = "Verteilung einfallendes Licht";
        tab.rows[2].cells[0].innerHTML = "Reflektionskoeffizient (0..1)";
        tab.rows[3].cells[0].innerHTML = "Verteilung reflektiertes Licht";

        for (let i = 0; i < nc - 1; i++) {
          tab.rows[0].cells[i + 1].innerHTML =
            i < ld ? theDat[0][i] : "RGB".charAt(i - ld);
          tab.rows[1].cells[i + 1].innerHTML = i < ld ? theDat[1][i] : "";
          tab.rows[2].cells[i + 1].innerHTML = i < ld ? theDat[2][i] : "";
        }

        return tab;
      }

      function fillTabWithDat(theTab, theDat) {
        if (!theTab || !theDat) return;

        let ld = theDat[0].length;
        let nc = ld + 4; // incl. name, R, G, B
        let nr = 4;

        for (let i = 0; i < ld; i++) {
          theTab.rows[3].cells[i + 1].innerHTML = fmt2(
            theDat[1][i] * theDat[2][i]
          );
        }
        return theTab;
      }

      function generateTableAsChildOf(numCols, numRows, papa, className) {
        let theTab = document.createElement("table");
        theTab.className = !className ? "" : className;
        let tabBdy = document.createElement("tbody");

        // generate rows (TRs) with all the columns
        for (let r = 0; r < numRows; r++) {
          let currTR = document.createElement("tr");

          // generate all columns (TDs) in one row
          for (let c = 0; c < numCols; c++) {
            let currTD = document.createElement("td");
            currTR.appendChild(currTD);
          }
          tabBdy.appendChild(currTR);
        }

        theTab.appendChild(tabBdy);
        papa.appendChild(theTab);
        return theTab;
      }

      function fmt(v) {
        let r = "" + v;
        while (r.length < 5) r += "0";
        return r;
      }

      function fmt1(v) {
        let r = "" + rnd1(v);
        if (r.indexOf(".") < 0) r += ".0";
        return r;
      }

      function fmt2(v) {
        let r = "" + rnd(v);
        if (r.indexOf(".") < 0) r += ".0";
        while (r.length < 4) r += "0";
        return r;
      }

      function fmt3(v) {
        let r = "" + rnd(v);
        if (r.indexOf(".") < 0) r += ".0";
        while (r.length < 5) r += "0";
        return r;
      }

      function rnd1(v) {
        return ((v * 10 + 0.5) | 0) / 10;
      }

      function rnd(v) {
        return ((v * 1000 + 0.5) | 0) / 1000;
      }

      var hex = "0123456789ABCDEF";
      function map_0to1_00toFF(v) {
        if (v <= 0) return "00";
        if (v >= 1) return "FF";
        v = (v * 255 + 0.5) | 0;
        return hex.charAt(v / 16) + hex.charAt(v % 16);
      }

      function linInt(v, f1, t1, f2, t2) {
        return t1 + ((v - f1) * (t2 - t1)) / (f2 - f1);
      }

      function linIntCol(r1, g1, b1, r2, g2, b2, w2) {
        if (true) {
          // 1. shift in a way, that the min-value get 0
          // 2. then scale with max -> dominat channel is scaled up to 1
          let l1 = Math.min(r1, Math.min(g1, b1));
          let l2 = Math.min(r2, Math.min(g2, b2));
          r1 -= l1;
          g1 -= l1;
          b1 -= l1;
          r2 -= l2;
          g2 -= l2;
          b2 -= l2;
          let m1 = Math.max(r1, Math.max(g1, b1));
          let m2 = Math.max(r2, Math.max(g2, b2));
          r1 /= m1;
          g1 /= m1;
          b1 /= m1;
          r2 /= m2;
          g2 /= m2;
          b2 /= m2;
        }

        // NOTE: the dataset has for >=700n always r=2g -> a kind of orange (not red!)
        //       we could try to strenghten the dominant color, BUT: then e.g. cyan area gets narrower
        //  -> should we use a n exponent, which runs from e.g. 2 for red until -0.5 (sqrt) for cyan (over magenta and yellow)?

        if (false) {
          // 1. approach: use square to keep 1 for the dominat channel but decrease influence of the others
          r1 *= r1;
          g1 *= g1;
          b1 *= b1;
          r2 *= r2;
          g2 *= g2;
          b2 *= b2;
        }

        if (true) {
          // 2. approach: use exponent
          let e1 = r1 * 2 + (1 - r1) * 0.5;
          let e2 = r2 * 2 + (1 - r2) * 0.5;

          r1 = Math.pow(r1, e1);
          g1 = Math.pow(g1, e1);
          b1 = Math.pow(b1, e1);
          r2 = Math.pow(r2, e2);
          g2 = Math.pow(g2, e2);
          b2 = Math.pow(b2, e2);
        }

        let w1 = 1 - w2;
        return (
          "#" +
          map_0to1_00toFF(r1 * w1 + r2 * w2) +
          map_0to1_00toFF(g1 * w1 + g2 * w2) +
          map_0to1_00toFF(b1 * w1 + b2 * w2)
        );
      }

      function linIntCol2(r1, g1, b1, r2, g2, b2, w2, wg) {
        if (true) {
          // 1. shift in a way, that the min-value get 0
          // 2. then scale with max -> dominat channel is scaled up to 1
          let l1 = Math.min(r1, Math.min(g1, b1));
          let l2 = Math.min(r2, Math.min(g2, b2));
          r1 -= l1;
          g1 -= l1;
          b1 -= l1;
          r2 -= l2;
          g2 -= l2;
          b2 -= l2;
          let m1 = Math.max(r1, Math.max(g1, b1));
          let m2 = Math.max(r2, Math.max(g2, b2));
          r1 /= m1;
          g1 /= m1;
          b1 /= m1;
          r2 /= m2;
          g2 /= m2;
          b2 /= m2;
        }

        if (true) {
          // 2. approach: use exponent
          let e1 = r1 * 2 + (1 - r1) * 0.8;
          let e2 = r2 * 2 + (1 - r2) * 0.8;

          r1 = Math.pow(r1, e1);
          g1 = Math.pow(g1, e1);
          b1 = Math.pow(b1, e1);
          r2 = Math.pow(r2, e2);
          g2 = Math.pow(g2, e2);
          b2 = Math.pow(b2, e2);
        }

        let w1 = 1 - w2;
        let wG = 1 - wg;
        return (
          "#" +
          map_0to1_00toFF((r1 * w1 + r2 * w2) * wG + rgbAcrm[0] * wg) +
          map_0to1_00toFF((g1 * w1 + g2 * w2) * wG + rgbAcrm[1] * wg) +
          map_0to1_00toFF((b1 * w1 + b2 * w2) * wG + rgbAcrm[2] * wg)
        );
      }

      // see data for CIE 1931 standard colorimetric observer
      var mcCurve = [
        //  0 nm   1 R       2 G       3 B         4 x       5 y
        //                          [380,   0.001368, 0.000039, 0.006450,   0.174110, 0.004960],
        //                          [385,   0.002236, 0.000064, 0.010550,   0.174010, 0.004980],
        //                          [390,   0.004243, 0.000120, 0.020050,   0.173800, 0.004920],
        //                          [395,   0.007650, 0.000217, 0.036210,   0.173560, 0.004920],
        //                          [400,   0.014310, 0.000396, 0.067850,   0.173340, 0.004800],
        //                          [405,   0.023190, 0.000640, 0.110200,   0.173020, 0.004780],
        [410, 0.04351, 0.00121, 0.2074, 0.17258, 0.0048],
        [415, 0.07763, 0.00218, 0.3713, 0.17209, 0.00483],
        [420, 0.13438, 0.004, 0.6456, 0.17141, 0.0051],
        [425, 0.21477, 0.0073, 1.03905, 0.1703, 0.00579],
        [430, 0.2839, 0.0116, 1.3856, 0.16888, 0.0069],
        [435, 0.3285, 0.01684, 1.62296, 0.1669, 0.00856],
        [440, 0.34828, 0.023, 1.74706, 0.16441, 0.01086],
        [445, 0.34806, 0.0298, 1.7826, 0.1611, 0.01379],
        [450, 0.3362, 0.038, 1.77211, 0.15664, 0.0177],
        [455, 0.3187, 0.048, 1.7441, 0.15099, 0.02274],
        [460, 0.2908, 0.06, 1.6692, 0.14396, 0.0297],
        [465, 0.2511, 0.0739, 1.5281, 0.1355, 0.03988],
        [470, 0.19536, 0.09098, 1.28764, 0.12412, 0.0578],
        [475, 0.1421, 0.1126, 1.0419, 0.10959, 0.08684],
        [480, 0.09564, 0.13902, 0.81295, 0.09129, 0.1327],
        [485, 0.05795, 0.1693, 0.6162, 0.06871, 0.20072],
        [490, 0.03201, 0.20802, 0.46518, 0.04539, 0.29498],
        [495, 0.0147, 0.2586, 0.3533, 0.02346, 0.4127],
        [500, 0.0049, 0.323, 0.272, 0.00817, 0.53842],
        [505, 0.0024, 0.4073, 0.2123, 0.00386, 0.65482],
        [510, 0.0093, 0.503, 0.1582, 0.01387, 0.75019],
        [515, 0.0291, 0.6082, 0.1117, 0.03885, 0.81202],
        [520, 0.06327, 0.71, 0.07825, 0.0743, 0.8338],
        [525, 0.1096, 0.7932, 0.05725, 0.11416, 0.82621],
        [530, 0.1655, 0.862, 0.04216, 0.15472, 0.80586],
        [535, 0.22575, 0.91485, 0.02984, 0.19288, 0.78163],
        [540, 0.2904, 0.954, 0.0203, 0.22962, 0.75433],
        [545, 0.3597, 0.9803, 0.0134, 0.26578, 0.72432],
        [550, 0.43345, 0.99495, 0.00875, 0.3016, 0.69231],
        [555, 0.51205, 1.0, 0.00575, 0.33736, 0.65885],
        [560, 0.5945, 0.995, 0.0039, 0.3731, 0.62445],
        [565, 0.6784, 0.9786, 0.00275, 0.40874, 0.58961],
        [570, 0.7621, 0.952, 0.0021, 0.44406, 0.55471],
        [575, 0.8425, 0.9154, 0.0018, 0.47877, 0.5202],
        [580, 0.9163, 0.87, 0.00165, 0.51249, 0.48659],
        [585, 0.9786, 0.8163, 0.0014, 0.54479, 0.45443],
        [590, 1.0263, 0.757, 0.0011, 0.57515, 0.42423],
        [595, 1.0567, 0.6949, 0.001, 0.60293, 0.3965],
        [600, 1.0622, 0.631, 0.0008, 0.62704, 0.37249],
        [605, 1.0456, 0.5668, 0.0006, 0.64823, 0.35139],
        [610, 1.0026, 0.503, 0.00034, 0.66576, 0.33401],
        [615, 0.9384, 0.4412, 0.00024, 0.68008, 0.31975],
        [620, 0.85445, 0.381, 0.00019, 0.6915, 0.30834],
        [625, 0.7514, 0.321, 0.0001, 0.70061, 0.2993],
        [630, 0.6424, 0.265, 0.00005, 0.70792, 0.29203],
        [635, 0.5419, 0.217, 0.00003, 0.71403, 0.28593],
        [640, 0.4479, 0.175, 0.00002, 0.71903, 0.28093],
        [645, 0.3608, 0.1382, 0.00001, 0.72303, 0.27695],
        [650, 0.2835, 0.107, 0.0, 0.72599, 0.27401],
        [655, 0.2187, 0.0816, 0.0, 0.72827, 0.27173],
        [660, 0.1649, 0.061, 0.0, 0.72997, 0.27003],
        [665, 0.1212, 0.04458, 0.0, 0.73109, 0.26891],
        [670, 0.0874, 0.032, 0.0, 0.73199, 0.26801],
        [675, 0.0636, 0.0232, 0.0, 0.73272, 0.26728],
        [680, 0.04677, 0.017, 0.0, 0.73342, 0.26658],
        [685, 0.0329, 0.01192, 0.0, 0.73405, 0.26595],
        [690, 0.0227, 0.00821, 0.0, 0.73439, 0.26561],
        [695, 0.01584, 0.005723, 0.0, 0.73459, 0.26541],
        [700, 0.011359, 0.004102, 0.0, 0.73469, 0.26531],
        //                           [705,   0.008111, 0.002929, 0.000000,   0.734690, 0.265310],
        //                           [710,   0.005790, 0.002091, 0.000000,   0.734690, 0.265310],
        //                           [715,   0.004109, 0.001484, 0.000000,   0.734690, 0.265310],
        //                           [720,   0.002899, 0.001047, 0.000000,   0.734690, 0.265310],
        //                           [725,   0.002049, 0.000740, 0.000000,   0.734690, 0.265310],
        //                           [730,   0.001440, 0.000520, 0.000000,   0.734690, 0.265310],
        //                           [735,   0.001000, 0.000361, 0.000000,   0.734690, 0.265310],
        //                           [740,   0.000690, 0.000249, 0.000000,   0.734690, 0.265310],
        //                           [745,   0.000476, 0.000172, 0.000000,   0.734690, 0.265310],
        //                           [750,   0.000332, 0.000120, 0.000000,   0.734690, 0.265310],
        //                           [755,   0.000235, 0.000085, 0.000000,   0.734690, 0.265310],
        //                           [760,   0.000166, 0.000060, 0.000000,   0.734690, 0.265310],
        //                           [765,   0.000117, 0.000042, 0.000000,   0.734690, 0.265310],
        //                           [770,   0.000083, 0.000030, 0.000000,   0.734690, 0.265310],
        //                           [775,   0.000059, 0.000021, 0.000000,   0.734690, 0.265310],
        //                           [780,   0.000042, 0.000015, 0.000000,   0.734690, 0.265310]
      ];
    </script>
  </body>
</html>
